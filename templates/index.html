<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Mapbox Application</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map-container {
      width: 100vw;
      height: 100vh;
    }

    .map-overlay {
      font:
        12px/20px 'Helvetica Neue',
        Arial,
        Helvetica,
        sans-serif;
      position: absolute;
      width: 350px;
      top: 0;
      left: 0;
      padding: 10px;
    }

    .map-overlay .map-overlay-inner {
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      border-radius: 3px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .map-overlay-inner fieldset {
      display: flex;
      justify-content: space-between;
      border: none;
    }

    .map-overlay-inner label {
      font-weight: bold;
      margin-right: 10px;
    }

    .map-overlay-inner .select-fieldset {
      display: block;
    }

    .map-overlay-inner .select-fieldset label {
      display: block;
      margin-bottom: 5px;
    }

    .map-overlay-inner .select-fieldset select {
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map-container"></div>
  <div class="map-overlay top">
    <div class="map-overlay-inner">
     <h1>Yale Shuttle Route Finder</h1>
      <p>Click to select start and end points.</p>
        <fieldset class="select-fieldset">
            <label id="coord1">Start Coord:</label>
            <label id="coord2">End Coord:</label>
        </fieldset>
    </div>
  </div>


  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic29seWNhIiwiYSI6ImNpejhqZmlmNjAwMDUycW82N3g2dG05ZHYifQ.CKn9Ww3bjhirdny-PIZqdg';
    const map = new mapboxgl.Map({
      container: 'map-container',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-72.923995, 41.309798],
      zoom: 12
    });

    let markers = {};
    let coordtoggle = true;
    var startCoordList = null;
    var endCoordList = null;

    const colorDict = {
      '1': '#DAD2D8',
      '2': '#143642',
      '3': '#0F8B8D',
      '8': '#EC9A29',
      '9': '#2B061E',
      '10': '#BA2D0B',
      '11': '#003E1F',
      '12': '#D5F2E3'
    };

    function getMarkerColor(route) {
      return colorDict[route] || '#000000'; // Assign default color if not found in the dictionary
    }

    function updateMarkers(data) {
      data.forEach(row => {
        const { id, name, lat, lon, heading, route, lastStop, lastUpdate } = row;
        const key = `${route}-${id}`;
        if (markers[key]) {
          // Update the position of the existing marker
          markers[key].setLngLat([lon, lat]);
        } else {
          // Create a new marker
          const color = getMarkerColor(route);
          markers[key] = new mapboxgl.Marker({
            color: color
          })
            .setLngLat([lon, lat])
            .addTo(map);
        }

        markers[key].setPopup(
          new mapboxgl.Popup()
            .setHTML(`
                <h3>Route ${route}</h3>
                <p>Name: ${name}</p>
                <p>Heading: ${heading}Â°</p>
                <p>Last stop: ${lastStop}</p>
                <p>Last update: ${new Date(lastUpdate * 1000).toLocaleString()}</p>
              `)
        );
      });
    }

    function updateStops(stops) {
      stops.forEach(row => {
          const { id, name, lat, lon } = row;
          const key = `${id}`;
          if (markers[key]) {
            // Update the position of the existing marker
            markers[key].setLngLat([lon, lat]);
          } else {
            // Create a new marker
            markers[key] = new mapboxgl.Marker({
              color: '#000000'
            })
            .setLngLat([lon, lat])
            .addTo(map);
          }

          markers[key].setPopup(
            new mapboxgl.Popup()
              .setHTML(`
                <p>Name: ${name}</p>
              `)
          );
        });

    }

    function fetchAndUpdateData() {
      fetch('http://localhost:3000/data')
        .then(response => response.json())
        .then(data => {
          updateMarkers(data);
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
    }

    function fetchAndUpdateStops() {
      fetch('http://localhost:3000/stops')
        .then(response => response.json())
        .then(data => {
          updateMarkers(data);
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
    }

    /*function sendCoordinates(start, end) {
      if (startCoordList != null && endCoordList != null) {
        fetch('/receive-coordinates', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ start: startCoordList, end: endCoordList })
        })
          .then(response => {
            if (response.ok) {
              console.log('Coordinates sent successfully!');
            } else {
              console.error('Failed to send coordinates.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      } else {
        console.error("Error: No valid pair of coordinates available to send.")
      }
    }*/

    function findShortestRoute(startCoord, endCoord) {
      // Send the coordinates to the server to find the shortest route
      fetch('/find-shortest-route', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ start: startCoord, end: endCoord })
      })
        .then(response => {
          if (response.ok) {
            return response.text(); // Return the response text (shortest route)
          } else {
            throw new Error('Failed to find shortest route.');
          }
        })
        .then(route => {
          // Display the shortest route
          console.log('Shortest Route:', route);
          // You can display the route in your HTML or perform any other actions here
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }
    //onClick, update the end coordinates, and pass them to the server to find the shortest route. Also checks for user location.
    map.on('click', (e) => {
      if (startCoordList == null) {
        document.getElementById('coord1').innerHTML = "No user location";
        document.getElementById('coord2').innerHTML = "Please enable location with the button the top right of the map.";
      } else {
        endCoordList = [e.lngLat.lng, e.lngLat.lat];
        document.getElementById('coord2').innerHTML = "End Coord: " + endCoordList.toString();

        findShortestRoute(startCoordList, endCoordList);
      }
    });

    /*
      For geolocation to work, the browser needs to allow the local server access to the location. Because the connection isn't secure,
      it is blocked by default for security reasons. You can disable it like so:
      https://stackoverflow.com/questions/57450093/browser-says-camera-blocked-to-protect-your-privacy
      (This says for the camera, but it applies to all browser permissions.)
      After that you can click the button on the top right to give the map your location.
    */
    // START Geolocation
    const geolocate = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true
    });

    map.addControl(geolocate);

    geolocate.on('geolocate', (e) => {
      var lon = e.coords.longitude;
      var lat = e.coords.latitude;
      startCoordList = [lon, lat];
      document.getElementById('coord1').innerHTML = "Start Coord: " + startCoordList.toString();
      document.getElementById('coord2').innerHTML = "End Coord: ";
      console.log('A geolocate event has occurred.');
    });
    // END Geolocation

    fetchAndUpdateData();
    setInterval(fetchAndUpdateData, 10000); // Update every 10 seconds
  </script>
</body>

</html>
